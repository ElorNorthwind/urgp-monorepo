-- Замы
DROP TABLE IF EXISTS dm.zams CASCADE;
CREATE TABLE dm.zams
(
    id INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    title TEXT,
    surname VARCHAR(255),
    first_name VARCHAR(255),
    last_name VARCHAR(255),
    full_name text GENERATED ALWAYS AS (
       COALESCE(title || ' ', '') || COALESCE(surname, '') || COALESCE(' ' || first_name, '') || COALESCE( ' ' || last_name, '')
    ) STORED,
    short_name text GENERATED ALWAYS AS (
        COALESCE(surname || ' ', '') || COALESCE(LEFT(first_name, 1) || '.', '') || COALESCE(LEFT(last_name, 1) || '.', 'Прямое подчинение')
    ) STORED,

    PRIMARY KEY (id)
);
-- ALTER TABLE dm.zams
--     OWNER to renovation_user;

INSERT INTO dm.zams (id, title, surname, first_name, last_name) VALUES
    (1,'Подразделения прямого подчинения',null,null,null),
    (2,'Первый заместитель руководителя','Спесивцева','Елена','Юрьевна'),
    (3,'Первый заместитель руководителя','Пушкарь','Яна','Анатольевна'),
    (4,'Заместитель руководителя','Биктимиров','Руслан','Гумерович'),
    (5,'Заместитель руководителя','Гдлян','Анджела','Тельмановна'),
    (6,'Заместитель руководителя','Кузменко','Анна','Михайловна'),
    (7,'Заместитель руководителя','Никифор','Андрей','Сергеевич'),
    (8,'Заместитель руководителя','Полещук','Никита','Григорьевич'),
    (9,'Заместитель руководителя','Спирин','Владислав','Сергеевич');


-- Управления
DROP TABLE IF EXISTS dm.departments CASCADE;
CREATE TABLE dm.departments
(
    id INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    department_name TEXT,
    boss_name VARCHAR(255),
    zam_id INTEGER REFERENCES dm.zams(id) ON DELETE SET NULL,
    display_name text GENERATED ALWAYS AS (
       COALESCE(department_name, '') || COALESCE(' (' || boss_name || ')', '') 
    ) STORED,

    PRIMARY KEY (id)
);
-- ALTER TABLE dm.departments
--     OWNER to renovation_user;

INSERT INTO dm.departments (id, department_name, boss_name, zam_id) VALUES
    (1,'Отдел внутренних и внешних коммуникаций','Баданеу Н.Ф.',1),
    (2,'Первый отдел','Суходолов А.Б.',1),
    (3,'Управление координации деятельности Департамента','Новикова И.А.',1),
    (4,'Управление имуществом органов власти и государственных учреждений','Карнеева Е.С.',2),
    (5,'Управление оформления имущества некоммерческих организаций','Ртищева Д.С.',2),
    (6,'Управление перераспределения имущества между публичными образованиями','Скрипка М.В.',2),
    (7,'Управление городским имуществом в ВАО','Уткин А.В.',3),
    (8,'Управление городским имуществом в ЗАО','и.о. Румянцев П.А.',3),
    (9,'Управление городским имуществом в ЗелАО','Чичерина Н.В.',3),
    (10,'Управление городским имуществом в САО','Мелещенина Н.А.',3),
    (11,'Управление городским имуществом в СВАО','Ильина Л.В.',3),
    (12,'Управление городским имуществом в СЗАО','Симонов С.О.',3),
    (13,'Управление городским имуществом в ТиНАО','Чумачков С.В.',3),
    (14,'Управление городским имуществом в ЦАО','Серик А.Г.',3),
    (15,'Управление городским имуществом в ЮАО','Золотов В.Л.',3),
    (16,'Управление городским имуществом в ЮВАО','Демонова Л.В.',3),
    (17,'Управление городским имуществом в ЮЗАО','Заикина О.В.',3),
    (18,'Управление координации работ по объектам землеустройства и деятельности в округах','Дмитриева Н.В.',3),
    (19,'Управление оформления вторичных имущественно-земельных отношений','Смирнова С.В.',3),
    (20,'Управление перспективного развития','Газарова С.А.',3),
    (21,'Управление приватизации городского имущества','Файнгерш С.И.',3),
    (22,'Управление ведения жилищного учета','Мусиенко О.А.',4),
    (23,'Управление информатизации','Николаев А.В.',4),
    (24,'Управление оформления жилищных правоотношений','Пахмутов С.А.',4),
    (25,'Управление переселения','Замураев А.Ю.',4),
    (26,'Управление по предоставлению государственных услуг в жилищной сфере','Курзина Ю.А.',4),
    (27,'Управление реализации жилищных программ','Лукьянов М.Г.',4),
    (28,'Правовое управление','Чуксин И.В.',5),
    (29,'Управление оформления имущественных и земельно-правовых отношений','Мартьянов С.В.',5),
    (30,'Управление правового обеспечения в жилищной сфере','Спесивцева С.В.',5),
    (31,'Управление правового обеспечения в сфере защиты имущества','Семенюта Н.В.',5),
    (32,'Управление правового обеспечения в сфере земельно-правовых отношений','Шатихин Н.В.',5),
    (33,'АО ЦУГИ','Рябов Д.В.',6),
    (34,'ГБУ ЦИП','Ковалев Д.В.',6),
    (35,'Управление корпоративных отношений','Табельский А.Н.',6),
    (36,'Управление экономики','Мишин И.В.',6),
    (37,'ГКУ МЦН','Степаненко А.В.',7),
    (38,'Управление по реализации градостроительной политики и транспортной инфраструктуры','Лапковская Е.В.',7),
    (39,'ГБУ МосгорБТИ','Тётушкин Д.Н.',8),
    (40,'Управление обеспечения кадастрового учета и регистрации прав','Стифеева А.С.',8),
    (41,'Управление по формированию земельных участков','Воронков И.В.',8),
    (42,'Второй отдел','Шевельков А.В.',9),
    (43,'Управление административно-хозяйственного обеспечения','Старухин С.А.',9),
    (44,'Управление государственной службы и кадров','Маковская В.М.',9),
    (45,'Управление делами','Афанасьева Е.А.',9),
    (46,'Финансовое управление','Ярыгина М.С.',9),
    (47, 'КП «Управление гражданского строительства города Москвы»', 'Рябов Д.В.', 6),
    (48, 'АО «Центр-Сити»', 'Рябов Д.В.', 6),
    (49, 'КП «КРТ»', 'Дружинина А.П.', 6);

-- Рубрики
DROP TABLE IF EXISTS dm.categories CASCADE;
CREATE TABLE dm.categories
(
    id INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    department_id INTEGER REFERENCES dm.departments(id) ON DELETE SET NULL,
    category_code VARCHAR(50), 
    category_name TEXT,
    category_group VARCHAR(50),

    PRIMARY KEY (id)
);
-- ALTER TABLE dm.categories
--     OWNER to renovation_user;

INSERT INTO dm.categories (id, department_id, category_code, category_name) VALUES
    (16048,1,'14-999','СЭДО Отдел внутренних и внешних коммуникаций'),
    (28892,1,'14-Э','Электронный документ СЭДО Отдел внутренних и внешних коммуникаций'),
    (16050,2,'16-999','СЭДО Первый отдел'),
    (28889,2,'16-Э','Электронный документ СЭДО Первый отдел'),
    (16062,3,'28-999','СЭДО Управление координации деятельности Департамента'),
    (28888,3,'28-Э','Электронный документ СЭДО Управление координации деятельности Департамента'),
    (16057,4,'23-999','СЭДО Управление имуществом органов власти и государственных учреждений'),
    (28846,4,'23-Э','Электронный документ СЭДО Управление имуществом органов власти и государственных учреждений'),
    (32041,5,'72-999','Бумага Управление оформления имущества некоммерческих организаций'),
    (32042,5,'72-Э','Электронный документ СЭДО Управление оформления имущества некоммерческих организаций'),
    (32039,6,'71-999','Бумага Управление перераспределения имущества между публичными образованиями'),
    (32040,6,'71-Э','Электронный документ СЭДО Управление перераспределения имущества между публичными образованиями'),
    (16083,7,'49-999','СЭДО Управление городским имуществом в Восточном административном округе'),
    (28859,7,'49-Э','Электронный документ СЭДО Управление городским имуществом в Восточном административном округе'),
    (16084,8,'50-999','СЭДО Управление городским имуществом в Западном административном округе'),
    (28860,8,'50-Э','Электронный документ СЭДО Управление городским имуществом в Западном административном округе'),
    (16085,9,'51-999','СЭДО Управление городским имуществом в Зеленоградском административном округе'),
    (28866,9,'51-Э','Электронный документ СЭДО Управление городским имуществом в Зеленоградском административном округе'),
    (16086,10,'52-999','СЭДО Управление городским имуществом в Северном административном округе'),
    (28857,10,'52-Э','Электронный документ СЭДО Управление городским имуществом в Северном административном округе'),
    (16087,11,'53-999','СЭДО Управление городским имуществом в Северо-Восточном административном округе'),
    (28862,11,'53-Э','Электронный документ СЭДО Управление городским имуществом в Северо-Восточном административном округе'),
    (16088,12,'54-999','СЭДО Управление городским имуществом в Северо-Западном административном округе'),
    (28861,12,'54-Э','Электронный документ СЭДО Управление городским имуществом в Северо-Западном административном округе'),
    (16089,13,'55-999','СЭДО Управление городским имуществом в Троицком и Новомосковском  административных округах'),
    (28867,13,'55-Э','Электронный документ СЭДО Управление городским имуществом в Троицком и Новомосковском  административных округах'),
    (16090,14,'56-999','СЭДО Управление городским имуществом в Центральном административном округе'),
    (28865,14,'56-Э','Электронный документ СЭДО Управление городским имуществом в Центральном административном округе'),
    (16093,15,'59-999','СЭДО Управление городским имуществом в Южном административном округе'),
    (28858,15,'59-Э','Электронный документ СЭДО Управление городским имуществом в Южном административном округе'),
    (16091,16,'57-999','СЭДО Управление городским имуществом в Юго-Восточном административном округе'),
    (28863,16,'57-Э','Электронный документ СЭДО Управление городским имуществом в Юго-Восточном административном округе'),
    (16092,17,'58-999','СЭДО Управление городским имуществом в Юго-Западном административном округе'),
    (28864,17,'58-Э','Электронный документ СЭДО Управление городским имуществом в Юго-Западном административном округе'),
    (16063,18,'29-999','СЭДО Управление координации работ по объектам землеустройства и деятельности в округах'),
    (28856,18,'29-Э','Электронный документ СЭДО Управление координации работ по объектам землеустройства и деятельности в округах'),
    (16066,19,'32-999','СЭДО Управление оформления вторичных имущественно-земельных отношений'),
    (28878,19,'32-Э','Электронный документ СЭДО Управление оформления вторичных имущественно-земельных отношений'),
    (16071,20,'37-999','СЭДО Управление перспективного развития'),
    (28849,20,'37-Э','Электронный документ СЭДО Управление перспективного развития'),
    (16079,21,'45-999','СЭДО Управление приватизации городскогоимущества'),
    (28851,21,'45-Э','Электронный документ СЭДО Управление приватизации городского имущества'),
    (16054,22,'20-999','СЭДО Управление ведения жилищного учета'),
    (28884,22,'20-Э','Электронный документ СЭДО Управление ведения жилищного учета'),
    (16060,23,'26-999','СЭДО Управление информатизации'),
    (28872,23,'26-Э','Электронный документ СЭДО Управление информатизации'),
    (16061,24,'27-999','Бумага Управление оформления жилищных правоотношений'),
    (28886,24,'27-Э','Электронный документ СЭДО Управление оформления жилищных правоотношений'),
    (16070,25,'36-999','СЭДО Управление переселения'),
    (28883,25,'36-Э','Электронный документ СЭДО Управление переселения'),
    (16067,26,'33-999','Бумага Управление обеспечения граждан, состоящих на жилищном учете'),
    (28885,26,'33-Э','Электронный документ СЭДО Управление обеспечения граждан, состоящих на жилищном учете'),
    (16080,27,'46-999','Бумага Управление реализации жилищных программ'),
    (28874,27,'46-Э','Электронный документ СЭДО Управление реализации жилищных программ'),
    (16051,28,'17-999','СЭДО Правовое управление'),
    (28869,28,'17-Э','Электронный документ СЭДО Правовое управление'),
    (16068,29,'34-999','СЭДО Управление оформления имущественных и земельно-правовых отношений'),
    (28840,29,'34-Э','Электронный документ СЭДО Управление оформления имущественных и земельно-правовых отношений'),
    (16072,30,'38-999','Бумага Управление правового обеспечения в жилищной сфере'),
    (28881,30,'38-Э','Электронный документ СЭДО Управление правового обеспечения в жилищной сфере'),
    (16078,31,'44-999','СЭДО Управление правового обеспечения в сфере защиты имущества'),
    (28870,31,'44-Э','Электронный документ СЭДО Управление правового обеспечения в сфере защиты имущества'),
    (32043,32,'73-999','Бумага Управление правового обеспечения в сфере земельно-правовых отношений'),
    (32044,32,'73-Э','Электронный документ СЭДО Управление правового обеспечения в сфере земельно-правовых отношений'),
    (21740,33,'70-999','СЭДО ГУП ЦУГИ'),
    (28896,33,'70-Э','Электронный документ СЭДО ГУП ЦУГИ'),
    (21739,34,'69-999','СЭДО ГБУ ГЦИПиЖС'),
    (28894,34,'69-Э','Электронный документ СЭДО ГБУ "ГЦИПиЖС"'),
    (16074,35,'40-999','Бумага Управление корпоративных отношений'),
    (28854,35,'40-Э','Электронный документ СЭДО Управление корпоративных отношений'),
    (16082,36,'48-999','СЭДО Управление экономики'),
    (28879,36,'48-Э','Электронный документ СЭДО Управление экономики'),
    (21639,37,'68-999','СЭДО ГКУ МЦН'),
    (28897,37,'68-Э','Электронный документ СЭДО ГКУ "Московский центр недвижимоcти"'),
    (16075,38,'41-999','СЭДО Управление по реализации градостроительной политики и транспортной инфраструктуры'),
    (28876,38,'41-Э','Электронный документ СЭДО Управление по реализации градостроительной политики и транспортной инфраструктуры'),
    (21638,39,'67-999','СЭДО ГБУ МОСГОРБТИ'),
    (28895,39,'67-Э','Электронный документ СЭДО МосгорБТИ ГБУ'),
    (16065,40,'31-999','СЭДО Управление обеспечения кадастрового учета и регистрации прав'),
    (28839,40,'31-Э','Электронный документ СЭДО Управление обеспечения кадастрового учета и регистрации прав'),
    (16076,41,'42-999','СЭДО Управление по формированию земельных участков'),
    (28845,41,'42-Э','Электронный документ СЭДО Управление по формированию земельных участков'),
    (16046,42,'12-999','СЭДО Второй отдел'),
    (28890,42,'12-Э','Электронный документ СЭДО Второй отдел'),
    (16052,43,'18-999','СЭДО Управление административно-хозяйственного обеспечения'),
    (28841,43,'18-Э','Электронный документ СЭДО Управление административно-хозяйственного обеспечения'),
    (16055,44,'21-999','СЭДО Управление государственной службы и кадров'),
    (28847,44,'21-Э','Электронный документ СЭДО Управление государственной службы и кадров'),
    (16056,45,'22-999','СЭДО Управление делами'),
    (28871,45,'22-Э','Электронный документ СЭДО Управление делами'),
    (16053,46,'19-999','СЭДО Управление бюджетного планирования, бухгалтерского учета и государственного заказа'),
    (28842,46,'19-Э','Электронный документ СЭДО Управление бюджетного планирования, бухгалтерского учета и государственного заказа'),
    (60539,47,'83-999','Бумага КП «Управление гражданского строительства города Москвы»'),
    (60540,47,'83-Э','Электронный документ КП «Управление гражданского строительства города Москвы»'),
    (60541,48,'84-999','Бумага АО «Центр-Сити»'),
    (60542,48,'84-Э','Электронный документ АО «Центр-Сити»'),
    (60543,49,'85-999','Бумага КП «КРТ»'),
    (60544,49,'85-Э','Электронный  документ КП «КРТ»');

-- Документы
DROP TABLE IF EXISTS dm.documents CASCADE;

CREATE TABLE dm.documents
(
    id INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    category_id INTEGER, -- REFERENCES dm.categories(id) ON DELETE SET NULL,
    reg_num TEXT,
    reg_date TIMESTAMP WITH TIME ZONE,
    from_fio TEXT,

    PRIMARY KEY (id)
);
-- ALTER TABLE dm.documents
--     OWNER to renovation_user;


-- Поручения
DROP TABLE IF EXISTS dm.resolutions CASCADE;

CREATE TABLE dm.resolutions
(
    id INTEGER NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    document_id INTEGER REFERENCES dm.documents(id) ON DELETE SET NULL,
    resolution_text TEXT,
    control_date TIMESTAMP WITH TIME ZONE,
    done_date TIMESTAMP WITH TIME ZONE,

    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    is_original_given boolean GENERATED ALWAYS AS (
        LOWER(resolution_text) LIKE ANY(ARRAY['%оригинал передан%', '%передан оригинал%'])
    ) STORED,

    PRIMARY KEY (id)
);
-- ALTER TABLE dm.resolutions
--     OWNER to renovation_user;

CREATE INDEX idx_dm_resolutions_control_date ON dm.resolutions (control_date DESC);




-- Производственный календарь
DROP TABLE IF EXISTS dm.calendar CASCADE;

CREATE TABLE dm.calendar
(
    date DATE,
    is_workday BOOLEAN NOT NULL DEFAULT TRUE,
    PRIMARY KEY (date)
);


GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA dm TO dgi_bi_writer;
ALTER DEFAULT PRIVILEGES IN SCHEMA dm GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO dgi_bi_writer;

GRANT SELECT ON ALL TABLES IN SCHEMA dm TO dgi_bi_reader;
ALTER DEFAULT PRIVILEGES IN SCHEMA dm GRANT SELECT ON TABLES TO dgi_bi_reader;